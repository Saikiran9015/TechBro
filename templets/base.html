<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KropKart | Premium Agricultural Marketplace{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('serve_statics', filename='style.css') }}">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% block extra_head %}{% endblock %}
</head>

<body>
    <nav class="navbar">
        <a href="/" class="logo-text" style="display: flex; align-items: center; gap: 0.5rem;">
            <img src="{{ url_for('serve_statics', filename='krop.png') }}" alt="KropKart" style="height: 45px;">
            <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary);"></span>
        </a>
        <div class="nav-links" style="display: flex; gap: 1.5rem; align-items: center;">
            {% if session.get('user') %}
            <a href="/" style="color: var(--dark); text-decoration: none; font-weight: 500;">
                <i class="fas fa-home"></i> Home
            </a>
            <span class="show-md" style="font-weight: 600; color: var(--primary);">
                Hi, {{ session.get('name').split()[0] }} <span class="badge badge-ai" style="font-size: 0.7rem;">{{
                    session.get('user_type')|upper }}</span>
            </span>
            {% if session.get('user_type') != 'admin' %}
            <a href="/profile" style="color: var(--dark); text-decoration: none; font-weight: 500;">
                <i class="fas fa-user-circle"></i> Profile
            </a>
            {% endif %}
            <a href="/my-orders" style="color: var(--dark); text-decoration: none; font-weight: 500;">
                <i class="fas fa-box"></i> My Orders
            </a>
            <a href="/dashboard" class="btn btn-primary" style="padding: 0.5rem 1rem;">Dashboard</a>
            <a href="/logout" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Logout</a>
            {% else %}
            <a href="/" style="color: var(--dark); text-decoration: none; font-weight: 500;">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="/login" class="btn btn-primary">Login</a>
            <a href="/register" class="btn btn-secondary">Join Now</a>
            {% endif %}
            <div id="google_translate_element"></div>
        </div>
    </nav>

    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="animate-fade"
            style="margin-bottom: 2rem; padding: 1rem; border-radius: var(--radius); background: {% if category == 'success' %}#dcfce7{% else %}#fee2e2{% endif %}; border-left: 5px solid {% if category == 'success' %}var(--primary){% else %}#dc2626{% endif %}; box-shadow: var(--shadow);">
            <div class="flex-between">
                <span
                    style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: {% if category == 'success' %}var(--primary){% else %}#991b1b{% endif %};">
                    <i
                        class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
                    {{ message }}
                </span>
                <i class="fas fa-times" style="cursor: pointer; opacity: 0.5;"
                    onclick="this.parentElement.parentElement.remove()"></i>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- AI Chatbot Widget -->
    <div class="chat-trigger" onclick="toggleChat()">
        <i class="fas fa-robot fa-lg"></i>
    </div>

    <div class="chat-widget" id="chatWidget">
        <div class="chat-header">
            <span style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-microchip"></i> KropBot AI
            </span>
            <div style="display: flex; gap: 10px;">
                <i class="fas fa-compress-alt" onclick="toggleChat()" style="cursor: pointer; opacity: 0.8;"></i>
            </div>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-msg chat-msg-bot">
                Namaste! üôè I'm KropBot. <br>I can help you with:<br>‚Ä¢ Daily Mandi Prices üìà<br>‚Ä¢ Selling your harvest
                üöú<br>‚Ä¢ Organic farming tips üåø<br><br>What would you like to know?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" class="form-control" placeholder="Ask about prices, crops..."
                style="border-radius: 2rem; border: 1px solid var(--gray-300);"
                onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()"
                style="border-radius: 50%; width: 2.8rem; height: 2.8rem; padding: 0; min-width: 2.8rem;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <footer style="margin-top: auto; padding-top: 4rem; background: var(--dark); color: var(--gray-300);">
        <div class="container">
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 3rem; margin-bottom: 3rem;">
                <!-- Company Info -->
                <div>
                    <div style="margin-bottom: 1.5rem;">
                        <img src="{{ url_for('serve_statics', filename='krop.png') }}" alt="KropKart"
                            style="height: 40px; filter: brightness(100);">
                    </div>
                    <p style="margin-bottom: 1rem; line-height: 1.6;">Empowering farmers and connecting communities with
                        fresh, AI-verified produce straight from the source.</p>
                    <div style="display: flex; gap: 1rem; font-size: 1.2rem;">
                        <a href="#" class="text-muted" style="transition: color 0.3s;"><i
                                class="fab fa-facebook"></i></a>
                        <a href="#" class="text-muted" style="transition: color 0.3s;"><i
                                class="fab fa-twitter"></i></a>
                        <a href="#" class="text-muted" style="transition: color 0.3s;"><i
                                class="fab fa-instagram"></i></a>
                        <a href="#" class="text-muted" style="transition: color 0.3s;"><i
                                class="fab fa-linkedin"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 style="color: white; margin-bottom: 1.5rem;">Marketplace</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.8rem;"><a href="/citizen"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Buy Fresh
                                Produce</a></li>
                        <li style="margin-bottom: 0.8rem;"><a href="/landingb"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Bulk Sourcing</a>
                        </li>
                        <li style="margin-bottom: 0.8rem;"><a href="/landing"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Farmer
                                Dashboard</a></li>
                        <li style="margin-bottom: 0.8rem;"><a href="/"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Live Market
                                Prices</a></li>
                    </ul>
                </div>

                <!-- Support -->
                <div>
                    <h4 style="color: white; margin-bottom: 1.5rem;">Support</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.8rem;"><a href="#"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Help Center</a>
                        </li>
                        <li style="margin-bottom: 0.8rem;"><a href="#"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Terms of
                                Service</a></li>
                        <li style="margin-bottom: 0.8rem;"><a href="/refund-policy"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Refund Policy</a>
                        </li>
                        <li style="margin-bottom: 0.8rem;"><a href="#"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Privacy
                                Policy</a></li>
                        <li style="margin-bottom: 0.8rem;"><a href="#"
                                style="text-decoration: none; color: inherit; transition: color 0.2s;">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Newsletter -->
                <div>
                    <h4 style="color: white; margin-bottom: 1.5rem;">Stay Updated</h4>
                    <p style="margin-bottom: 1rem;">Subscribe for the latest crop prices and farming tips.</p>
                    <form style="display: flex; gap: 0.5rem;" onsubmit="event.preventDefault(); alert('Subscribed!');">
                        <input type="email" placeholder="Your email"
                            style="padding: 0.6rem; border-radius: 6px; border: none; flex: 1; background: #1e293b; color: white;">
                        <button type="submit" class="btn btn-primary"
                            style="padding: 0.6rem 1rem; border-radius: 6px;"><i
                                class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>

            <div style="border-top: 1px solid var(--gray-800); padding: 2rem 0; text-align: center;">
                <p>&copy; 2026 KropKart. All rights reserved. Beautifully Engineered with AI.</p>
            </div>
        </div>
    </footer>

    <script>
        function toggleChat() {
            const widget = document.getElementById('chatWidget');
            widget.classList.toggle('open');
            if (widget.classList.contains('open')) {
                document.getElementById('chatInput').focus();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const body = document.getElementById('chatBody');
            const text = input.value.trim();

            if (!text) return;

            // 1. Add User Message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-msg chat-msg-user';
            userMsg.innerText = text;
            body.appendChild(userMsg);

            input.value = '';
            body.scrollTop = body.scrollHeight;

            // 2. Add Typing Indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            body.appendChild(typingDiv);
            body.scrollTop = body.scrollHeight;

            try {
                // 3. Fetch Response
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();

                // 4. Remove Typing & Add Bot Message
                typingDiv.remove();

                const botMsg = document.createElement('div');
                botMsg.className = 'chat-msg chat-msg-bot';
                botMsg.innerHTML = data.response;
                body.appendChild(botMsg);

                body.scrollTop = body.scrollHeight;

            } catch (error) {
                console.error('Chat Error:', error);
                typingDiv.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-msg chat-msg-bot';
                errorMsg.innerText = "Sorry, I'm having trouble connecting to the farm servers right now. Please try again.";
                body.appendChild(errorMsg);
            }
        }
    </script>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'en' }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    {% block scripts %}{% endblock %}
</body>

</html>